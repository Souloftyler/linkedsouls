<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINKED SOULS - Dark Fantasy AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Lato:wght@400;700&display=swap');

        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --ethereal-blue: #3b82f6;
            --gold: #fbbf24;
            --fatigue-color: #a855f7;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: #0c0a09;
            color: #d6d3d1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        h1, h2, .fantasy-font { font-family: 'Cinzel', serif; }
        .story-text { font-family: 'Lora', serif; }

        .tab-content { display: none; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .tab-content.active { display: block; }

        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bottom-nav {
            padding-bottom: calc(0.5rem + var(--safe-area-inset-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,1);
        }

        .action-btn {
            background: linear-gradient(135deg, #1c1917 0%, #0c0a09 100%);
            border: 1px solid #44403c;
            transition: all 0.3s ease;
            text-align: left;
        }
        .action-btn:hover { border-color: var(--ethereal-blue); background: #1c1917; }
        .action-btn:active { transform: scale(0.98); }

        .equipment-slot {
            background: rgba(28, 25, 23, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .equipment-slot:hover { border-color: var(--ethereal-blue); }

        .item-notification {
            border-left: 3px solid var(--ethereal-blue);
            background: rgba(59, 130, 246, 0.1);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .save-card {
            background: linear-gradient(to right, rgba(28, 25, 23, 0.9), rgba(12, 10, 9, 0.9));
            border: 1px solid #292524;
            transition: all 0.2s;
        }
        .save-card:hover { border-color: #44403c; }

        /* Loader AI */
        .ai-loading {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 50;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .ai-loading.active { display: flex; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-stone-950">

    <!-- LOADER AI -->
    <div id="aiLoader" class="ai-loading">
        <div class="text-blue-500 text-4xl mb-4 pulse">üìú</div>
        <p class="fantasy-font text-stone-400 text-[10px] tracking-[0.3em] uppercase">Le Murmure des √Çmes...</p>
    </div>

    <!-- HEADER GLOBAL -->
    <header class="bg-stone-900 border-b border-stone-800 p-4 flex justify-between items-center z-10 shadow-2xl">
        <div class="flex items-center space-x-3">
            <div class="relative w-12 h-12">
                <canvas id="healthMiniChart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-[10px] font-bold text-red-700" id="hpValue">100</span>
                </div>
            </div>
            <div>
                <h1 class="text-stone-100 text-[11px] font-bold uppercase tracking-[0.4em]">Linked Souls</h1>
                <div class="flex items-center space-x-3 mt-1">
                    <span class="text-[9px] font-bold text-blue-400">‚öîÔ∏è <span id="header-stat-atk">0</span></span>
                    <span class="text-[9px] font-bold text-red-400">üõ°Ô∏è <span id="header-stat-def">0</span></span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <div class="flex items-center justify-end space-x-1 text-amber-500">
                <span class="text-xs font-bold" id="goldValue">50</span>
                <span class="text-[10px]">ü™ô</span>
            </div>
            <div class="flex flex-col items-end mt-1">
                <div class="flex items-center space-x-2">
                    <span id="fatigueText" class="text-[9px] text-purple-400 font-bold uppercase">Fatigu√© 0%</span>
                </div>
                <div class="w-24 h-1 bg-stone-800 rounded-full mt-1 overflow-hidden">
                    <div id="fatigueProgress" class="h-full bg-purple-600 transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow relative overflow-hidden bg-black">
        <!-- TAB: AVENTURE -->
        <div id="tab-story" class="tab-content active p-6 relative z-1">
            <div class="mb-4 flex justify-between items-center border-b border-stone-800 pb-2">
                <span id="currentLocationTitle" class="text-[10px] text-stone-500 uppercase tracking-widest font-bold">Lieu inconnu</span>
                <span class="text-[8px] text-stone-600 italic">G√©n√©ration Dynamique</span>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-6 fade-in">
                <div onclick="switchTab('inventory')" class="equipment-slot p-2 flex flex-col items-center justify-center border-stone-800 min-h-[75px]">
                    <p class="text-[6px] text-stone-500 uppercase font-bold mb-1 text-center">Main Droite</p>
                    <span class="text-lg" id="slot-rightHand">‚öîÔ∏è</span>
                    <p class="text-[8px] text-stone-200 font-bold truncate w-full text-center mt-1" id="name-rightHand">Vide</p>
                    <p class="text-[7px] text-blue-400 font-bold" id="desc-rightHand"></p>
                </div>
                <div onclick="switchTab('inventory')" class="equipment-slot p-2 flex flex-col items-center justify-center border-stone-800 min-h-[75px]">
                    <p class="text-[6px] text-stone-500 uppercase font-bold mb-1 text-center">Main Gauche</p>
                    <span class="text-lg" id="slot-leftHand">üõ°Ô∏è</span>
                    <p class="text-[8px] text-stone-200 font-bold truncate w-full text-center mt-1" id="name-leftHand">Vide</p>
                    <p class="text-[7px] text-red-400 font-bold" id="desc-leftHand"></p>
                </div>
                <div onclick="switchTab('inventory')" class="equipment-slot p-2 flex flex-col items-center justify-center border-stone-800 min-h-[75px]">
                    <p class="text-[6px] text-stone-500 uppercase font-bold mb-1 text-center">Corps</p>
                    <span class="text-lg" id="slot-armor">üëï</span>
                    <p class="text-[8px] text-stone-200 font-bold truncate w-full text-center mt-1" id="name-armor">Vide</p>
                    <p class="text-[7px] text-red-400 font-bold" id="desc-armor"></p>
                </div>
            </div>

            <div id="itemNotificationArea" class="space-y-2 mb-4"></div>
            <div id="storyLog" class="space-y-6 pb-80"></div>

            <div class="fixed bottom-24 left-0 right-0 px-6 pointer-events-none">
                <div id="actionPanel" class="max-w-md mx-auto flex flex-col gap-2 pointer-events-auto"></div>
            </div>
        </div>

        <!-- TAB: SAC -->
        <div id="tab-inventory" class="tab-content p-8 relative z-1">
            <div class="flex justify-between items-end mb-6 border-b border-stone-800 pb-3">
                <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em]">Sac d'Aventure</h2>
                <div class="flex space-x-4">
                    <span class="text-blue-400 text-[10px] font-bold">ATK: <span id="stat-atk">0</span></span>
                    <span class="text-red-400 text-[10px] font-bold">DEF: <span id="stat-def">0</span></span>
                </div>
            </div>
            <div id="inventoryList" class="space-y-4 pb-20"></div>
        </div>

        <!-- TAB: √âCHOS -->
        <div id="tab-journal" class="tab-content p-8 relative z-1">
            <div class="flex justify-between items-center mb-6 border-b border-stone-800 pb-3">
                <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em]">M√©moires de la Cendre</h2>
                <button onclick="resetGame()" class="text-[8px] text-red-500 font-bold border border-red-900/50 px-2 py-1 rounded bg-red-950/20 hover:bg-red-900/40 transition-colors uppercase tracking-widest">R√©initialiser</button>
            </div>
            
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-stone-400 text-[9px] font-bold uppercase tracking-widest">Points de Passage</h3>
                    <button onclick="manualSave()" class="text-[8px] text-blue-400 font-bold border border-blue-900/50 px-2 py-1 rounded bg-blue-950/20 hover:bg-blue-900/40 transition-colors uppercase">Sauvegarder</button>
                </div>
                <div id="saveSlotsContainer" class="space-y-3"></div>
            </div>

            <div class="mb-8">
                <h3 class="text-stone-400 text-[9px] font-bold uppercase tracking-widest mb-4">Journal</h3>
                <div id="journalList" class="space-y-4 pb-20"></div>
            </div>
        </div>
    </main>

    <!-- NAV -->
    <nav class="bottom-nav bg-stone-900 border-t border-stone-800 flex justify-around items-center py-4 z-20">
        <button onclick="switchTab('story')" class="nav-item flex flex-col items-center text-blue-500" id="nav-story">
            <span class="text-xl">üß≠</span>
            <span class="text-[8px] font-bold uppercase mt-1 tracking-widest">Aventure</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center text-stone-600" id="nav-inventory">
            <span class="text-xl">üéí</span>
            <span class="text-[8px] font-bold uppercase mt-1 tracking-widest">Sac</span>
        </button>
        <button onclick="switchTab('journal')" class="nav-item flex flex-col items-center text-stone-600" id="nav-journal">
            <span class="text-xl">üìú</span>
            <span class="text-[8px] font-bold uppercase mt-1 tracking-widest">√âchos</span>
        </button>
    </nav>

    <script>
        const apiKey = ""; // La cl√© est inject√©e par l'environnement
        const defaultState = {
            hp: 100,
            gold: 50,
            fatigue: 0,
            equipment: { rightHand: null, leftHand: null, armor: null },
            inventory: [
                { id: 'iron_sword', name: "√âp√©e de Fer Froid", icon: "‚öîÔ∏è", type: "weapon", desc: "Forg√©e dans les mines de l'Ouest.", value: 12 },
                { id: 'leather_armor', name: "Cuir Bouilli", icon: "üõ°Ô∏è", type: "armor", desc: "Protection souple.", value: 8 },
                { id: 'torches', name: "Torches", icon: "üî¶", type: "consumable", desc: "R√©duit la fatigue.", count: 3 }
            ],
            notes: ["D√©but de l'errance."],
            currentStep: 'port_start',
            history: [] // Historique des interactions pour Gemini
        };

        let state = JSON.parse(JSON.stringify(defaultState));

        // Prompt Syst√®me pour Gemini
        const SYSTEM_PROMPT = `Tu es le Ma√Ætre du Jeu d'un RPG de Dark Fantasy appel√© "Linked Souls". 
        Ton style est po√©tique, sombre, m√©lancolique (inspiration Dark Souls). 
        L'histoire doit se g√©n√©rer dynamiquement.
        IMPORTANT: Tu dois r√©pondre UNIQUEMENT avec un objet JSON valide au format suivant :
        {
            "title": "Nom du lieu",
            "text": "Description narrative riche du lieu et de ce qu'il s'y passe.",
            "actions": [
                {"label": "Texte court de l'action", "icon": "Emoji", "fatigue": nombre_fatigue, "cost": nombre_or, "impact": "Br√®ve description de l'impact interne (optionnel)"}
            ],
            "note": "Br√®ve phrase pour le journal si important",
            "loot": {"name": "Nom", "icon": "Emoji", "type": "weapon|armor|offhand|consumable", "value": nombre, "desc": "Description"} (Optionnel)
        }
        R√®gle : Toujours proposer 2 √† 3 actions. Int√®gre les stats du joueur dans la narration (S'il a peu de PV, d√©cris sa blessure).`;

        // --- GEMINI API INTEGRATION ---
        async function fetchGeminiStory(userChoice = "D√©but du voyage") {
            const loader = document.getElementById('aiLoader');
            loader.classList.add('active');

            const userPrompt = `√âtat actuel du joueur : 
            PV: ${state.hp}/100, Or: ${state.gold}, Fatigue: ${state.fatigue}%.
            √âquipement: ATK ${state.equipment.rightHand?.value || 0}, DEF ${(state.equipment.armor?.value || 0) + (state.equipment.leftHand?.value || 0)}.
            Historique r√©cent : ${state.history.slice(-3).join(" -> ")}.
            Action choisie par le joueur : "${userChoice}".
            G√©n√®re la suite de l'aventure.`;

            let retries = 5;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) throw new Error('API Error');
                    
                    const data = await response.json();
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    
                    loader.classList.remove('active');
                    processDynamicStep(result, userChoice);
                    return;

                } catch (error) {
                    retries--;
                    if (retries === 0) {
                        loader.classList.remove('active');
                        showNotification("Les √¢mes sont silencieuses... R√©essayez.");
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        function processDynamicStep(data, lastChoice) {
            state.history.push(lastChoice);
            if (data.note) state.notes.push(data.note);
            if (data.loot) addItem(data.loot);

            // Mise √† jour UI
            const locTitle = document.getElementById('currentLocationTitle');
            if(locTitle) locTitle.innerText = data.title;

            const log = document.getElementById('storyLog');
            if(log) {
                log.innerHTML = `<div class="fade-in bg-stone-900/80 p-6 rounded-3xl border border-stone-800 shadow-2xl backdrop-blur-md">
                    <p class="story-text text-stone-300 leading-relaxed text-[12px] italic font-medium">${data.text}</p>
                </div>`;
            }

            const panel = document.getElementById('actionPanel');
            if(panel) {
                panel.innerHTML = '';
                data.actions.forEach(act => {
                    const btn = document.createElement('button');
                    const canAfford = (!act.cost || state.gold >= act.cost) && state.fatigue < 100;
                    btn.className = `action-btn w-full flex items-center justify-between p-4 rounded-2xl text-stone-400 font-bold uppercase tracking-[0.2em] text-[9px] ${!canAfford ? 'opacity-40 pointer-events-none' : ''}`;
                    btn.innerHTML = `<span>${act.icon} ${act.label} ${act.cost ? `(${act.cost}g)` : ''}</span> <span>‚Üí</span>`;
                    btn.onclick = () => {
                        if (act.fatigue) state.fatigue = Math.min(100, state.fatigue + act.fatigue);
                        if (act.cost) state.gold -= act.cost;
                        // On lance la g√©n√©ration suivante
                        fetchGeminiStory(act.label);
                    };
                    panel.appendChild(btn);
                });
            }
            updateUI();
            saveGame();
        }

        // --- SAVE SYSTEM ---
        function saveGame(isManual = false) {
            const saves = JSON.parse(localStorage.getItem('ls_saves') || '[]');
            const newSave = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('fr-FR'),
                location: document.getElementById('currentLocationTitle').innerText,
                state: JSON.parse(JSON.stringify(state)),
                isAuto: !isManual
            };
            if (!isManual) {
                const autoIdx = saves.findIndex(s => s.isAuto);
                if (autoIdx > -1) saves.splice(autoIdx, 1);
            }
            saves.unshift(newSave);
            if (saves.length > 12) saves.pop();
            localStorage.setItem('ls_saves', JSON.stringify(saves));
            if (isManual) showNotification("M√©moire ancr√©e.");
            updateSaveSlotsUI();
        }

        function loadSpecificSave(id) {
            const saves = JSON.parse(localStorage.getItem('ls_saves') || '[]');
            const save = saves.find(s => s.id === id);
            if (save) {
                state = JSON.parse(JSON.stringify(save.state));
                // On relance √† partir du dernier point connu
                fetchGeminiStory("Reprise de la m√©moire");
                switchTab('story');
            }
        }

        function resetGame() {
            if (confirm("Voulez-vous vraiment tout oublier ?")) {
                localStorage.removeItem('ls_saves');
                state = JSON.parse(JSON.stringify(defaultState));
                fetchGeminiStory("Commencement");
                switchTab('story');
            }
        }

        // --- UTILS ---
        function addItem(item) {
            if (!item.id) item.id = 'loot_' + Date.now();
            state.inventory.push(item);
            showNotification(`Trouv√© : ${item.name}`);
        }

        function showNotification(text) {
            const area = document.getElementById('itemNotificationArea');
            const notif = document.createElement('div');
            notif.className = "item-notification p-3 rounded-xl text-[9px] text-blue-200 italic shadow-lg mb-2 fade-in";
            notif.innerText = `‚ú® ${text}`;
            area.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        function updateUI() {
            document.getElementById('hpValue').innerText = Math.max(0, state.hp);
            document.getElementById('goldValue').innerText = state.gold;
            if(healthChart) {
                healthChart.data.datasets[0].data = [state.hp, 100 - state.hp];
                healthChart.update();
            }
            const atk = state.equipment.rightHand?.value || 0;
            const def = (state.equipment.armor?.value || 0) + (state.equipment.leftHand?.value || 0);
            document.getElementById('header-stat-atk').innerText = atk;
            document.getElementById('header-stat-def').innerText = def;
            document.getElementById('stat-atk').innerText = atk;
            document.getElementById('stat-def').innerText = def;

            document.getElementById('fatigueProgress').style.width = `${state.fatigue}%`;
            document.getElementById('fatigueText').innerText = `Fatigu√© ${state.fatigue}%`;

            ["rightHand", "leftHand", "armor"].forEach(s => {
                const eq = state.equipment[s];
                document.getElementById(`slot-${s}`).innerText = eq ? eq.icon : (s==='armor'?'üëï':(s==='leftHand'?'üõ°Ô∏è':'‚öîÔ∏è'));
                document.getElementById(`name-${s}`).innerText = eq ? eq.name : "Vide";
            });
        }

        function updateInventoryUI() {
            const invList = document.getElementById('inventoryList');
            invList.innerHTML = '';
            state.inventory.forEach(item => {
                const isEq = Object.values(state.equipment).some(e => e && e.id === item.id);
                invList.innerHTML += `
                    <div onclick="handleItemClick('${item.id}')" class="bg-stone-900/60 p-4 rounded-2xl border ${isEq ? 'border-blue-500' : 'border-stone-800'} flex items-center space-x-4">
                        <span class="text-2xl">${item.icon}</span>
                        <div class="flex-grow">
                            <h3 class="text-[9px] font-bold text-stone-300 uppercase">${item.name}</h3>
                            <p class="text-[8px] text-stone-500 italic">${item.desc}</p>
                        </div>
                    </div>`;
            });
        }

        function handleItemClick(id) {
            const item = state.inventory.find(i => i.id === id);
            if (!item) return;
            if (["weapon", "armor", "offhand"].includes(item.type)) {
                const slot = item.type === 'weapon' ? 'rightHand' : (item.type === 'armor' ? 'armor' : 'leftHand');
                state.equipment[slot] = (state.equipment[slot]?.id === item.id) ? null : item;
            } else if (item.type === 'consumable') {
                if (item.id === 'torches') state.fatigue = Math.max(0, state.fatigue - 30);
                item.count = (item.count || 1) - 1;
                if (item.count <= 0) state.inventory = state.inventory.filter(i => i.id !== id);
            }
            updateUI();
            updateInventoryUI();
            saveGame();
        }

        function updateSaveSlotsUI() {
            const container = document.getElementById('saveSlotsContainer');
            const saves = JSON.parse(localStorage.getItem('ls_saves') || '[]');
            container.innerHTML = saves.map(s => `
                <div class="save-card p-3 rounded-xl flex justify-between items-center">
                    <div class="cursor-pointer flex-grow" onclick="loadSpecificSave(${s.id})">
                        <h4 class="text-[9px] font-bold ${s.isAuto ? 'text-amber-500' : 'text-blue-400'} uppercase">${s.isAuto ? '[AUTO] ' : ''}${s.location}</h4>
                        <p class="text-[7px] text-stone-500">${s.timestamp}</p>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.replace('text-blue-500', 'text-stone-600'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('nav-' + id).classList.replace('text-stone-600', 'text-blue-500');
            if(id === 'inventory') updateInventoryUI();
            if(id === 'journal') {
                document.getElementById('journalList').innerHTML = state.notes.map(n => `<div class="bg-stone-900/40 p-4 border border-stone-800 rounded-xl text-[10px] italic text-stone-400">"${n}"</div>`).join('');
                updateSaveSlotsUI();
            }
        }

        let healthChart = null;
        window.onload = () => {
            const canvas = document.getElementById('healthMiniChart');
            healthChart = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: { datasets: [{ data: [100, 0], backgroundColor: ['#991b1b', '#1c1917'], borderWidth: 0 }] },
                options: { cutout: '85%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
            
            // Charger la derni√®re auto-save ou commencer
            const saves = JSON.parse(localStorage.getItem('ls_saves') || '[]');
            const last = saves.find(s => s.isAuto);
            if (last) {
                state = last.state;
                fetchGeminiStory("Reprise de l'√©veil");
            } else {
                fetchGeminiStory("Le premier souffle");
            }
        };
    </script>
</body>
</html>
