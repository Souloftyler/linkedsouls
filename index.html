<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LINKED SOULS - √âchos des T√©n√®bres</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Lato:wght@400;700&display=swap');

        :root {
            --ethereal-blue: #3b82f6;
            --gold: #fbbf24;
            --blood: #991b1b;
        }

        /* Fix pour la hauteur r√©elle sur mobile */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #0c0a09;
        }

        body {
            font-family: 'Lato', sans-serif;
            color: #d6d3d1;
            display: flex;
            flex-direction: column;
        }
        
        h1, h2, .fantasy-font { font-family: 'Cinzel', serif; }
        .story-text { font-family: 'Lora', serif; line-height: 1.8; }

        /* Conteneur principal flexible */
        main {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Zone de d√©filement pour les onglets */
        .tab-content { 
            display: none; 
            flex: 1;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; /* Scroll fluide iOS */
            padding-bottom: 3rem;
            touch-action: pan-y;
        }
        .tab-content.active { display: block; }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .action-btn {
            background: linear-gradient(135deg, #1c1917 0%, #0c0a09 100%);
            border: 1px solid #44403c;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }
        .action-btn:active { transform: scale(0.98); background: #1c1917; }
        .action-btn.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }

        .equipment-slot {
            background: rgba(28, 25, 23, 0.9);
            border: 1px solid rgba(68, 64, 60, 0.5);
            border-radius: 8px;
            transition: all 0.3s;
        }
        .equipment-slot.active { border-color: var(--ethereal-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }

        .item-card {
            background: linear-gradient(to right, #1c1917, #0c0a09);
            border: 1px solid #292524;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 10px; }
    </style>
</head>
<body class="bg-stone-950">

    <!-- HEADER -->
    <header class="flex-none bg-stone-900/95 border-b border-stone-800 p-4 flex justify-between items-center z-20 backdrop-blur-md">
        <div class="flex items-center space-x-4">
            <div class="relative w-12 h-12">
                <canvas id="healthMiniChart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-[10px] font-bold text-red-500" id="hpValue">100</span>
                </div>
            </div>
            <div>
                <h1 class="text-stone-100 text-[9px] font-bold uppercase tracking-[0.2em]">√Çme Li√©e</h1>
                <div class="flex items-center space-x-3 mt-1">
                    <span class="text-[9px] text-blue-400 font-bold">‚öîÔ∏è <span id="header-stat-atk">0</span></span>
                    <span class="text-[9px] text-red-400 font-bold">üõ°Ô∏è <span id="header-stat-def">0</span></span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <div class="flex items-center justify-end space-x-1 text-amber-500">
                <span class="text-xs font-bold" id="goldValue">50</span>
                <span class="text-[10px]">ü™ô</span>
            </div>
            <div class="w-16 bg-stone-800 h-1 rounded-full mt-1 border border-stone-700">
                <div id="fatigueProgress" class="h-full bg-purple-600 transition-all duration-700" style="width: 0%"></div>
            </div>
        </div>
    </header>

    <main>
        <!-- ONGLET: MONDE -->
        <div id="tab-story" class="tab-content active p-6">
            <div class="flex justify-between items-center mb-6 border-b border-stone-800 pb-2">
                <span id="currentLocationTitle" class="text-[10px] text-stone-400 uppercase tracking-widest font-bold italic">Lieu Inconnu</span>
                <span class="text-[8px] px-2 py-0.5 bg-stone-800 rounded text-stone-600 font-bold uppercase tracking-tighter">Exploration</span>
            </div>
            
            <!-- √âQUIPEMENT -->
            <div class="grid grid-cols-3 gap-2 mb-8">
                <div class="equipment-slot p-2 flex flex-col items-center justify-center min-h-[90px]" id="ui-slot-rightHand">
                    <span class="text-[7px] text-stone-500 uppercase font-bold mb-1">Arme</span>
                    <span class="text-xl mb-1" id="icon-rightHand">‚öîÔ∏è</span>
                    <p class="text-[8px] text-stone-200 font-bold text-center leading-tight truncate w-full" id="name-rightHand">Vide</p>
                </div>
                <div class="equipment-slot p-2 flex flex-col items-center justify-center min-h-[90px]" id="ui-slot-leftHand">
                    <span class="text-[7px] text-stone-500 uppercase font-bold mb-1">Gauche</span>
                    <span class="text-xl mb-1" id="icon-leftHand">üõ°Ô∏è</span>
                    <p class="text-[8px] text-stone-200 font-bold text-center leading-tight truncate w-full" id="name-leftHand">Vide</p>
                </div>
                <div class="equipment-slot p-2 flex flex-col items-center justify-center min-h-[90px]" id="ui-slot-armor">
                    <span class="text-[7px] text-stone-500 uppercase font-bold mb-1">Armure</span>
                    <span class="text-xl mb-1" id="icon-armor">üëï</span>
                    <p class="text-[8px] text-stone-200 font-bold text-center leading-tight truncate w-full" id="name-armor">Vide</p>
                </div>
            </div>

            <div id="itemNotificationArea" class="mb-4 space-y-2"></div>
            
            <!-- CONTENU NARRATIF -->
            <div id="storyLog" class="space-y-6"></div>

            <!-- ACTIONS (Incluses dans le scroll) -->
            <div class="mt-8 pb-12">
                <div id="actionPanel" class="flex flex-col gap-3">
                    <!-- Boutons ici -->
                </div>
            </div>
        </div>

        <!-- ONGLET: SAC -->
        <div id="tab-inventory" class="tab-content p-6">
            <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em] mb-4 border-b border-stone-800 pb-2">Inventaire</h2>
            <div id="inventoryList" class="space-y-3"></div>
        </div>

        <!-- ONGLET: JOURNAL -->
        <div id="tab-journal" class="tab-content p-6">
            <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em] mb-4 border-b border-stone-800 pb-2">Notes</h2>
            <div id="journalList" class="space-y-3"></div>
        </div>

        <!-- ONGLET: MENU -->
        <div id="tab-settings" class="tab-content p-6">
            <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em] mb-4 border-b border-stone-800 pb-2">Syst√®me</h2>
            <button onclick="confirmReset()" class="w-full py-4 border border-red-900/40 text-red-500 text-[9px] font-bold uppercase rounded-lg">
                Effacer la progression
            </button>
        </div>
    </main>

    <!-- NAVIGATION -->
    <nav class="flex-none bg-stone-900 border-t border-stone-800 flex justify-around items-center py-3 z-30">
        <button onclick="switchTab('story')" class="nav-item flex flex-col items-center text-blue-500" id="nav-story">
            <span class="text-xl">üß≠</span>
            <span class="text-[8px] font-bold uppercase mt-1">Monde</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center text-stone-600" id="nav-inventory">
            <span class="text-xl">üéí</span>
            <span class="text-[8px] font-bold uppercase mt-1">Sac</span>
        </button>
        <button onclick="switchTab('journal')" class="nav-item flex flex-col items-center text-stone-600" id="nav-journal">
            <span class="text-xl">üìú</span>
            <span class="text-[8px] font-bold uppercase mt-1">Notes</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center text-stone-600" id="nav-settings">
            <span class="text-xl">‚öôÔ∏è</span>
            <span class="text-[8px] font-bold uppercase mt-1">Menu</span>
        </button>
    </nav>

    <script>
        // --- DONN√âES ET LOGIQUE ---
        const STOCK_LIMITS = { 'fiole_rouge': 3, 'fiole_verte': 3, 'rations': 5 };

        let state = {
            hp: 100, gold: 50, fatigue: 0,
            equipment: { rightHand: null, leftHand: null, armor: null },
            inventory: [
                { id: 'fiole_rouge', name: "Fiole de Sang", icon: "üß™", type: "consumable", count: 2, heal: 40, desc: "Soin vital." },
                { id: 'rations', name: "Rations", icon: "üçû", type: "consumable", count: 2, heal: 15, desc: "Vivres simples." }
            ],
            notes: ["R√©veil √† Port-Sable."],
            currentStep: 'port_entry'
        };

        const storyData = {
            port_entry: {
                title: "Quais de Port-Sable",
                text: "La brume rampe sur les pav√©s disjoints, portant l'odeur de la pourriture et de l'iode. Devant une cabane de bois flott√©, **Elias le P√™cheur** recoud un filet dont les mailles semblent capturer les murmures du vent. Plus loin, le vacarme du March√© Noir r√©sonne contre les murs de pierre suintants. La Route du Sud, quant √† elle, s'enfonce dans une p√©nombre inqui√©tante, l√† o√π peu osent s'aventurer sans une bonne escorte.",
                actions: [
                    { label: "Parler √† Elias", next: 'elias_talk', icon: "üë§" },
                    { label: "Aller au March√© Noir", next: 'black_market', icon: "üè∫" },
                    { label: "Route du Sud", next: 'south_road', icon: "ü•æ", fatigue: 15 }
                ]
            },
            elias_talk: {
                title: "Conseils d'Elias",
                text: "¬´ Les Sombres-lianes qui infestent le Sud ont appris √† craindre l'acier. Mais l'acier ne suffit pas toujours. Ne n√©gligez pas vos forces ; un homme √©puis√© est une proie facile. ¬ª",
                actions: [
                    { label: "Demander de l'aide", next: 'elias_gift', cost: 10, icon: "ü™ô" },
                    { label: "Retourner aux quais", next: 'port_entry', icon: "‚Ü©Ô∏è" }
                ]
            },
            elias_gift: {
                title: "Geste de Gratitude",
                text: "Il vous tend une fiole verte. ¬´ C'est de la ros√©e matinale. √áa calme les membres fatigu√©s. Allez, partez maintenant. ¬ª",
                actions: [{ label: "Continuer", next: 'port_entry', icon: "üß≠" }],
                onEnter: () => addItem({ id: 'fiole_verte', name: "Ros√©e", icon: "üß™", type: "consumable", count: 1, restoreFatigue: true, desc: "Redonne de l'√©nergie." })
            },
            black_market: {
                title: "Le March√© Noir",
                text: "Un lieu de troc pour ceux qui pr√©f√®rent l'anonymat. Ma√Ætre Silas vend des armes anciennes √† prix d'or.",
                actions: [
                    { label: "Lame Noire (40g)", next: 'buy_sword', cost: 40, icon: "üó°Ô∏è" },
                    { label: "Quitter", next: 'port_entry', icon: "‚Ü©Ô∏è" }
                ]
            },
            buy_sword: {
                title: "Achat de Lame",
                text: "L'acier est froid, presque surnaturel.",
                actions: [{ label: "Retourner", next: 'black_market', icon: "‚Ü©Ô∏è" }],
                onEnter: () => addItem({ id: 'dark_blade', name: "Lame Noire", icon: "‚öîÔ∏è", type: "weapon", value: 15, desc: "Forg√©e dans l'ombre." })
            },
            south_road: {
                title: "Route du Sud",
                text: "La route est bloqu√©e par un spectre. Le combat semble in√©vitable.",
                actions: [
                    { label: "Combattre (-20 PV)", next: 'port_entry', icon: "‚öîÔ∏è" }
                ],
                onEnter: () => { state.hp -= 20; updateUI(); }
            }
        };

        let healthChart = null;

        function updateUI() {
            document.getElementById('hpValue').innerText = Math.max(0, state.hp);
            document.getElementById('goldValue').innerText = state.gold;
            document.getElementById('header-stat-atk').innerText = state.equipment.rightHand?.value || 0;
            document.getElementById('header-stat-def').innerText = (state.equipment.leftHand?.value || 0) + (state.equipment.armor?.value || 0);
            document.getElementById('fatigueProgress').style.width = state.fatigue + "%";

            ['rightHand', 'leftHand', 'armor'].forEach(slot => {
                const item = state.equipment[slot];
                document.getElementById('name-' + slot).innerText = item ? item.name : 'Vide';
                document.getElementById('icon-' + slot).innerText = item ? item.icon : (slot==='armor'?'üëï':slot==='leftHand'?'üõ°Ô∏è':'‚öîÔ∏è');
                document.getElementById('ui-slot-' + slot).classList.toggle('active', !!item);
            });

            if (healthChart) {
                healthChart.data.datasets[0].data = [state.hp, 100 - state.hp];
                healthChart.update();
            }
        }

        function renderStep(stepId) {
            const step = storyData[stepId];
            if (!step) return;
            state.currentStep = stepId;
            if (step.onEnter) step.onEnter();

            const tab = document.getElementById('tab-story');
            tab.scrollTop = 0; // Reset scroll

            document.getElementById('currentLocationTitle').innerText = step.title;
            document.getElementById('storyLog').innerHTML = `
                <div class="fade-in bg-stone-900/40 p-5 rounded-xl border border-stone-800/50">
                    <p class="story-text text-stone-300 text-sm italic">${step.text}</p>
                </div>`;

            const panel = document.getElementById('actionPanel');
            panel.innerHTML = '';
            step.actions.forEach(act => {
                const canAfford = !act.cost || state.gold >= act.cost;
                const btn = document.createElement('button');
                btn.className = `action-btn p-4 rounded-xl flex justify-between items-center text-[10px] font-bold uppercase tracking-widest ${!canAfford ? 'disabled' : ''}`;
                btn.innerHTML = `<span>${act.icon} ${act.label} ${act.cost ? `(${act.cost}g)` : ''}</span> <span>‚Üí</span>`;
                btn.onclick = (e) => {
                    e.preventDefault();
                    if (act.cost) state.gold -= act.cost;
                    if (act.fatigue) state.fatigue = Math.min(100, state.fatigue + act.fatigue);
                    renderStep(act.next);
                };
                panel.appendChild(btn);
            });
            updateUI();
        }

        function addItem(item) {
            const limit = STOCK_LIMITS[item.id];
            const existing = state.inventory.find(i => i.id === item.id);
            if (limit && existing && existing.count >= limit) return false;

            if (existing) existing.count++;
            else state.inventory.push({ ...item });
            
            showNotification(`+ ${item.name}`);
            updateUI();
            return true;
        }

        function useItem(itemId) {
            const index = state.inventory.findIndex(i => i.id === itemId);
            const item = state.inventory[index];
            if (['weapon', 'armor', 'offhand'].includes(item.type)) {
                let slot = item.type === 'weapon' ? 'rightHand' : (item.type === 'armor' ? 'armor' : 'leftHand');
                state.equipment[slot] = (state.equipment[slot]?.id === item.id) ? null : item;
            } else {
                if (item.heal) state.hp = Math.min(100, state.hp + item.heal);
                if (item.restoreFatigue) state.fatigue = 0;
                item.count--;
                if (item.count <= 0) state.inventory.splice(index, 1);
            }
            updateUI();
            updateInventoryUI();
        }

        function updateInventoryUI() {
            const list = document.getElementById('inventoryList');
            list.innerHTML = state.inventory.map(item => {
                const isEq = Object.values(state.equipment).some(e => e?.id === item.id);
                return `
                    <div onclick="useItem('${item.id}')" class="item-card p-4 rounded-xl flex items-center gap-4 border ${isEq ? 'border-blue-500 bg-blue-900/10' : 'border-stone-800'}">
                        <span class="text-xl">${item.icon}</span>
                        <div class="flex-grow">
                            <h3 class="text-[10px] font-bold uppercase text-stone-100">${item.name} ${item.count > 1 ? `(x${item.count})` : ''}</h3>
                            <p class="text-[8px] text-stone-500 italic">${item.desc}</p>
                        </div>
                    </div>`;
            }).join('');
        }

        function showNotification(msg) {
            const area = document.getElementById('itemNotificationArea');
            const el = document.createElement('div');
            el.className = "fade-in p-2 bg-blue-900/20 text-blue-300 border-l-2 border-blue-500 text-[9px] font-bold uppercase";
            el.innerText = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.replace('text-blue-500', 'text-stone-600'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('nav-' + id).classList.replace('text-stone-600', 'text-blue-500');
            if(id === 'inventory') updateInventoryUI();
        }

        function confirmReset() {
            if(confirm("R√©initialiser ?")) { localStorage.clear(); location.reload(); }
        }

        window.onload = () => {
            const ctx = document.getElementById('healthMiniChart').getContext('2d');
            healthChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { datasets: [{ data: [100, 0], backgroundColor: ['#991b1b', '#1c1917'], borderWidth: 0 }] }, 
                options: { cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } 
            });
            renderStep(state.currentStep);
        };
    </script>
</body>
</html>
