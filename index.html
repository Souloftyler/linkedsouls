       <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINKED SOULS - √âchos des T√©n√®bres</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Lato:wght@400;700&display=swap');

        :root {
            --ethereal-blue: #3b82f6;
            --gold: #fbbf24;
            --blood: #991b1b;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: #0c0a09;
            color: #d6d3d1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        h1, h2, .fantasy-font { font-family: 'Cinzel', serif; }
        .story-text { font-family: 'Lora', serif; line-height: 1.8; }

        /* Correction du scroll : on permet au contenu de d√©filer sous le header fixe */
        .tab-content { 
            display: none; 
            /* Hauteur moins Header (80px) et Nav (70px) */
            height: calc(100vh - 80px - 70px); 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 40px; /* Espace pour la navigation en bas */
        }
        .tab-content.active { display: block; }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .action-btn {
            background: linear-gradient(135deg, #1c1917 0%, #0c0a09 100%);
            border: 1px solid #44403c;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
        }
        .action-btn:active { transform: scale(0.98); }
        .action-btn.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }

        .equipment-slot {
            background: rgba(28, 25, 23, 0.9);
            border: 1px solid rgba(68, 64, 60, 0.5);
            border-radius: 8px;
            transition: all 0.3s;
        }
        .equipment-slot.active { border-color: var(--ethereal-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }

        .item-card {
            background: linear-gradient(to right, #1c1917, #0c0a09);
            border: 1px solid #292524;
            transition: border-color 0.3s;
        }
        .item-card.at-max { border-color: #7f1d1d; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0c0a09; }
        ::-webkit-scrollbar-thumb { background: #292524; border-radius: 10px; }
    </style>
</head>
<body class="bg-stone-950">

    <!-- HEADER: √âTAT DU PERSONNAGE -->
    <header class="bg-stone-900/90 border-b border-stone-800 p-4 flex justify-between items-center z-20 backdrop-blur-md sticky top-0">
        <div class="flex items-center space-x-4">
            <div class="relative w-14 h-14">
                <canvas id="healthMiniChart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span class="text-xs font-bold text-red-500" id="hpValue">100</span>
                </div>
            </div>
            <div>
                <h1 class="text-stone-100 text-[10px] font-bold uppercase tracking-[0.3em]">√Çme Li√©e</h1>
                <div class="flex items-center space-x-3 mt-1">
                    <span class="flex items-center text-[10px] text-blue-400 font-bold">‚öîÔ∏è <span id="header-stat-atk" class="ml-1">0</span></span>
                    <span class="flex items-center text-[10px] text-red-400 font-bold">üõ°Ô∏è <span id="header-stat-def" class="ml-1">0</span></span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <div class="flex items-center justify-end space-x-1 text-amber-500 mb-1">
                <span class="text-sm font-bold" id="goldValue">50</span>
                <span class="text-xs">ü™ô</span>
            </div>
            <div class="w-24 bg-stone-800 h-1.5 rounded-full overflow-hidden border border-stone-700">
                <div id="fatigueProgress" class="h-full bg-purple-600 transition-all duration-700" style="width: 0%"></div>
            </div>
            <p id="fatigueText" class="text-[8px] text-stone-500 uppercase mt-1 font-bold tracking-tighter">Fatigue 0%</p>
        </div>
    </header>

    <main class="flex-grow relative">
        <!-- ONGLET: AVENTURE -->
        <div id="tab-story" class="tab-content active p-6">
            <div class="flex justify-between items-center mb-6 border-b border-stone-800 pb-2">
                <span id="currentLocationTitle" class="text-[10px] text-stone-400 uppercase tracking-widest font-bold italic"></span>
                <span class="text-[8px] px-2 py-0.5 bg-stone-800 rounded text-stone-600 font-bold uppercase">Chroniques</span>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-8">
                <div class="equipment-slot p-2 flex flex-col items-center justify-center min-h-[100px]" id="ui-slot-rightHand">
                    <span class="text-[7px] text-stone-500 uppercase font-bold mb-1">Arme</span>
                    <span class="text-2xl mb-1" id="icon-rightHand">‚öîÔ∏è</span>
                    <p class="text-[9px] text-stone-200 font-bold text-center leading-tight mb-1" id="name-rightHand">Vide</p>
                    <span class="text-[7px] font-bold text-blue-400" id="stat-rightHand"></span>
                </div>
                <div class="equipment-slot p-2 flex flex-col items-center justify-center min-h-[100px]" id="ui-slot-leftHand">
                    <span class="text-[7px] text-stone-500 uppercase font-bold mb-1">Bouclier</span>
                    <span class="text-2xl mb-1" id="icon-leftHand">üõ°Ô∏è</span>
                    <p class="text-[9px] text-stone-200 font-bold text-center leading-tight mb-1" id="name-leftHand">Vide</p>
                    <span class="text-[7px] font-bold text-red-400" id="stat-leftHand"></span>
                </div>
                <div class="equipment-slot p-2 flex flex-col items-center justify-center min-h-[100px]" id="ui-slot-armor">
                    <span class="text-[7px] text-stone-500 uppercase font-bold mb-1">Armure</span>
                    <span class="text-2xl mb-1" id="icon-armor">üëï</span>
                    <p class="text-[9px] text-stone-200 font-bold text-center leading-tight mb-1" id="name-armor">Vide</p>
                    <span class="text-[7px] font-bold text-red-400" id="stat-armor"></span>
                </div>
            </div>

            <div id="itemNotificationArea" class="mb-4 space-y-2"></div>
            <div id="storyLog" class="space-y-6"></div>

            <!-- MODIFICATION: Le panneau d'action est maintenant dans le flux de contenu et d√©file -->
            <div id="actionPanel" class="flex flex-col gap-2 mt-8"></div>
            
        </div>

        <!-- ONGLET: INVENTAIRE -->
        <div id="tab-inventory" class="tab-content p-8">
            <div class="sticky top-0 bg-stone-950 z-10 pb-4">
                <div class="flex justify-between items-center border-b border-stone-800 pb-3">
                    <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em]">Inventaire</h2>
                    <span class="text-[8px] text-stone-600 font-bold uppercase">Capacit√© Limit√©e</span>
                </div>
            </div>
            <div id="inventoryList" class="space-y-3"></div>
        </div>

        <!-- ONGLET: JOURNAL -->
        <div id="tab-journal" class="tab-content p-8">
            <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em] mb-6 border-b border-stone-800 pb-3">Notes de Voyage</h2>
            <div id="journalList" class="space-y-4"></div>
        </div>

        <!-- ONGLET: SETTINGS -->
        <div id="tab-settings" class="tab-content p-8">
            <h2 class="text-stone-500 text-[10px] font-bold uppercase tracking-[0.5em] mb-6 border-b border-stone-800 pb-3">Syst√®me</h2>
            <div id="saveList" class="space-y-3 mb-6"></div>
            <button onclick="confirmReset()" class="w-full py-4 border border-red-900/40 text-red-500 text-[9px] font-bold uppercase rounded-lg">
                Effacer la progression
            </button>
        </div>

        <!-- Custom Modal for Confirmation/Alerts (Replaces confirm()) -->
        <div id="customModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-stone-900 p-6 rounded-xl max-w-xs w-full border border-stone-800 shadow-2xl">
                <p id="modalMessage" class="text-stone-300 text-sm mb-4 story-text">√ätes-vous s√ªr de vouloir effacer toute votre progression ? Cette action est irr√©versible.</p>
                <div id="modalActions" class="flex justify-end space-x-3">
                    <button onclick="closeModal(false)" class="px-4 py-2 text-[10px] font-bold uppercase tracking-widest text-stone-400 hover:text-stone-200">Annuler</button>
                    <button id="modalConfirmBtn" onclick="modalConfirmHandler()" class="px-4 py-2 text-[10px] font-bold uppercase tracking-widest bg-red-700 hover:bg-red-800 text-white rounded-md transition duration-200">Confirmer</button>
                </div>
            </div>
        </div>

    </main>

    <!-- NAVIGATION -->
    <nav class="bg-stone-900 border-t border-stone-800 flex justify-around items-center py-4 z-30 fixed bottom-0 left-0 right-0">
        <button onclick="switchTab('story')" class="nav-item flex flex-col items-center text-blue-500" id="nav-story">
            <span class="text-xl">üß≠</span>
            <span class="text-[8px] font-bold uppercase mt-1">Monde</span>
        </button>
        <button onclick="switchTab('inventory')" class="nav-item flex flex-col items-center text-stone-600" id="nav-inventory">
            <span class="text-xl">üéí</span>
            <span class="text-[8px] font-bold uppercase mt-1">Sac</span>
        </button>
        <button onclick="switchTab('journal')" class="nav-item flex flex-col items-center text-stone-600" id="nav-journal">
            <span class="text-xl">üìú</span>
            <span class="text-[8px] font-bold uppercase mt-1">Journal</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center text-stone-600" id="nav-settings">
            <span class="text-xl">‚öôÔ∏è</span>
            <span class="text-[8px] font-bold uppercase mt-1">Menu</span>
        </button>
    </nav>

    <script>
        const STOCK_LIMITS = {
            'fiole_rouge': 3,
            'fiole_verte': 3,
            'torch': 5,
            'rations': 5
        };

        const INITIAL_STATE = {
            hp: 100,
            gold: 50,
            fatigue: 0,
            equipment: { rightHand: null, leftHand: null, armor: null },
            inventory: [
                { id: 'fiole_rouge', name: "Fiole de Sang", icon: "üß™", type: "consumable", count: 3, heal: 100, desc: "√âlixir vital." },
                { id: 'fiole_verte', name: "Fiole de Ros√©e", icon: "üß™", type: "consumable", count: 3, restoreFatigue: true, desc: "Infusion revigorante." },
                { id: 'torch', name: "Torche Bleue", icon: "üî•", type: "consumable", count: 5, desc: "Lumi√®re spectrale." },
                { id: 'rations', name: "Rations S√®ches", icon: "üçû", type: "consumable", count: 5, heal: 30, desc: "Vivres de voyage." },
                { id: 'rusty_blade', name: "Lame de Garde", icon: "‚öîÔ∏è", type: "weapon", value: 12, desc: "Acier marqu√© par le temps." },
                { id: 'leather_armor', name: "Cuir Bouilli", icon: "üõ°Ô∏è", type: "armor", value: 4, desc: "Souple et robuste." },
                { id: 'round_shield', name: "Bouclier Rond", icon: "üõ°Ô∏è", type: "offhand", value: 8, desc: "Bois cercl√© de fer." }
            ],
            notes: ["R√©veil pr√®s des quais..."],
            currentStep: 'port_entry'
        };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));

        /**
         * Calcule la menace de l'ennemi en fonction de l'√©quipement du joueur.
         * @param {number} baseAtk - Attaque de base de l'ennemi.
         * @returns {{atk: number, hp: number}} Les statistiques d'attaque et de PV de l'ennemi.
         */
        function getThreat(baseAtk) {
            const power = (state.equipment.rightHand?.value || 0) + 
                          (state.equipment.leftHand?.value || 0) + 
                          (state.equipment.armor?.value || 0);
            return {
                atk: Math.floor(baseAtk + (power * 0.45)),
                hp: Math.floor(60 + (power * 1.5))
            };
        }

        const storyData = {
            port_entry: {
                title: "Quais de Port-Sable",
                text: "Les eaux de la baie sont immobiles, noires comme de l'encre renvers√©e sous un ciel sans lune. Une brume √©paisse rampe sur les pav√©s disjoints, portant l'odeur de la pourriture noble et de l'iode. Devant une cabane de bois flott√©, **Elias le P√™cheur** recoud un filet dont les mailles semblent capturer les murmures du vent.",
                actions: [
                    { label: "Parler √† Elias", next: 'elias_talk', icon: "üë§" },
                    { label: "Aller au March√© Noir", next: 'black_market', icon: "üè∫" },
                    { label: "Prendre la Route du Sud", next: 'south_road', icon: "ü•æ", fatigue: 15 }
                ]
            },
            elias_talk: {
                title: "Conseils d'un Vieil Homme",
                text: "Elias ne l√®ve pas les yeux de son ouvrage. ¬´ Les Sombres-lianes qui infestent la route du Sud ont appris √† craindre l'acier, √©tranger. Plus votre lame est tranchante, plus leur √©corce s'endurcit. Ne n√©gligez pas vos torches ; l'ombre n'aime pas √™tre r√©v√©l√©e. ¬ª",
                actions: [
                    { label: "Lui donner 5 pi√®ces", next: 'elias_bless', cost: 5, icon: "ü™ô" },
                    { label: "Retourner aux quais", next: 'port_entry', icon: "‚Ü©Ô∏è" }
                ]
            },
            elias_bless: {
                title: "Geste de Gratitude",
                text: "Elias sort une petite fiole de sa besace. ¬´ Prenez ceci. Un reste de ros√©e matinale. √áa calme les membres fatigu√©s. ¬ª",
                actions: [{ label: "Continuer", next: 'port_entry', icon: "üß≠" }],
                onEnter: () => {
                    const added = addItem({ id: 'fiole_verte', name: "Fiole de Ros√©e", icon: "üß™", type: "consumable", count: 1, restoreFatigue: true, desc: "Infusion revigorante." });
                    if(!added) state.gold += 5;
                }
            },
            black_market: {
                title: "Le Bazar des Ombres",
                text: "Cach√© entre deux entrep√¥ts en ruine, le march√© bourdonne d'une activit√© illicite. **Ma√Ætre Silas**, un homme au visage masqu√© de bandages, expose des lames d'un noir mat. Plus loin, **Kaelen la Chasseuse** nettoie ses pi√®ges avec une pr√©cision de chirurgien.",
                actions: [
                    { label: "Ma√Ætre Silas (Armes)", next: 'silas_shop', icon: "‚öîÔ∏è" },
                    { label: "Acheter des Vivres (10g)", next: 'buy_food', cost: 10, icon: "üçû" },
                    { label: "Quitter le march√©", next: 'port_entry', icon: "‚Ü©Ô∏è" }
                ]
            },
            silas_shop: {
                title: "L'Arsenal de Silas",
                text: "Silas fait glisser une dague sur le velours. ¬´ L'acier de Port-Sable est tremp√© dans le regret. Choisissez bien. ¬ª",
                actions: [
                    { label: "√âp√©e Lourde (35g)", next: 'buy_sword', cost: 35, icon: "üó°Ô∏è" },
                    { label: "Bouclier d'Apparat (30g)", next: 'buy_shield', cost: 30, icon: "üõ°Ô∏è" },
                    { label: "Retourner", next: 'black_market', icon: "‚Ü©Ô∏è" }
                ]
            },
            buy_food: {
                title: "Ravitaillement",
                text: "Le marchand vous tend un paquet de viandes s√©ch√©es.",
                actions: [{ label: "Retourner", next: 'black_market', icon: "‚Ü©Ô∏è" }],
                onEnter: () => {
                    const added = addItem({ id: 'rations', name: "Rations S√®ches", icon: "üçû", type: "consumable", count: 1, heal: 30, desc: "Vivres de voyage." });
                    if(!added) state.gold += 10;
                }
            },
            buy_sword: {
                title: "Nouvelle Arme",
                text: "Vous sentez le poids r√©confortant de l'acier neuf.",
                actions: [{ label: "Continuer", next: 'black_market', icon: "‚Ü©Ô∏è" }],
                onEnter: () => {
                    addItem({ id: 'heavy_sword', name: "√âp√©e de Silas", icon: "‚öîÔ∏è", type: "weapon", value: 25, desc: "Forg√©e dans l'ombre." });
                }
            },
            buy_shield: {
                title: "Nouveau Bouclier",
                text: "Un bouclier massif, grav√© d'embl√®mes oubli√©s.",
                actions: [{ label: "Continuer", next: 'black_market', icon: "‚Ü©Ô∏è" }],
                onEnter: () => {
                    addItem({ id: 'ceremonial_shield', name: "√âcu d'Apparat", icon: "üõ°Ô∏è", type: "offhand", value: 15, desc: "Lourd et ornement√©." });
                }
            },
            south_road: {
                title: "La Route du Sud",
                text: "Le chemin s'enfonce dans une v√©g√©tation maladive. Une silhouette se d√©tache de l'ombre d'un ch√™ne mort.",
                actions: [
                    { label: "Combattre l'Apparition", next: 'fight_shadow', icon: "‚öîÔ∏è" },
                    { label: "Fuir vers le port", next: 'port_entry', icon: "üèÉ" }
                ]
            },
            fight_shadow: {
                title: "L'Ombre S'adapte",
                text: "La cr√©ature pousse un cri strident. Son corps se durcit au contact de votre lumi√®re.",
                actions: [
                    { label: "Victoire", next: 'port_entry', icon: "üèÜ" }
                ],
                onEnter: () => {
                    const enemy = getThreat(18);
                    const def = (state.equipment.armor?.value || 0) + (state.equipment.leftHand?.value || 0);
                    // D√©g√¢ts minimum assur√©s de 8
                    const dmg = Math.max(8, enemy.atk - def); 
                    state.hp -= dmg;
                    showNotification(`L'Ombre (ATK ${enemy.atk}) vous blesse de ${dmg} PV.`);
                }
            }
        };

        /**
         * Ajoute un objet √† l'inventaire, respectant les limites de stock.
         * @param {object} item - L'objet √† ajouter.
         * @returns {boolean} Vrai si l'objet a √©t√© ajout√©, faux si le stock maximum est atteint.
         */
        function addItem(item) {
            const limit = STOCK_LIMITS[item.id];
            const existing = state.inventory.find(i => i.id === item.id);

            if (limit !== undefined) {
                const currentCount = existing ? existing.count : 0;
                if (currentCount >= limit) {
                    showNotification(`Stock MAX atteint pour : ${item.name}`, true);
                    return false; 
                }
                
                if (existing) {
                    existing.count = Math.min(limit, existing.count + (item.count || 1));
                } else {
                    state.inventory.push({ ...item, count: item.count || 1 });
                }
            } else {
                state.inventory.push({ ...item, count: item.count || 1 });
            }
            
            showNotification(`+ ${item.name}`);
            updateInventoryUI();
            updateUI();
            saveGame();
            return true;
        }

        /**
         * Utilise ou √©quipe un objet de l'inventaire.
         * @param {string} itemId - L'identifiant de l'objet.
         */
        function useItem(itemId) {
            const index = state.inventory.findIndex(i => i.id === itemId);
            const item = state.inventory[index];
            if (!item) return;

            if (['weapon', 'armor', 'offhand'].includes(item.type)) {
                let slot = item.type === 'weapon' ? 'rightHand' : (item.type === 'armor' ? 'armor' : 'leftHand');
                
                if (state.equipment[slot]?.id === item.id) {
                    state.equipment[slot] = null;
                    showNotification(`${item.name} retir√©`);
                } else {
                    // √âquiper
                    // Trouver l'ancien objet (s'il existe) pour s'assurer qu'il reste dans l'inventaire
                    const oldItem = state.equipment[slot];
                    if (oldItem) {
                        // Pas besoin de d√©s√©quiper si l'objet est d√©j√† dans l'inventaire, 
                        // mais il faut s'assurer que l'√©tat d'√©quipement est mis √† jour
                    }
                    state.equipment[slot] = item;
                    showNotification(`${item.name} √©quip√©`);
                }
            } else {
                // Consommable
                if (item.heal) state.hp = Math.min(100, (item.heal === 100 ? 100 : state.hp + item.heal));
                if (item.restoreFatigue) state.fatigue = 0;
                
                item.count--;
                showNotification(`Utilisation de ${item.name}`);
                if (item.count <= 0) state.inventory.splice(index, 1);
            }
            updateUI();
            updateInventoryUI();
            saveGame();
        }

        let healthChart = null;

        /** Met √† jour tous les √©l√©ments d'interface utilisateur (stats, √©quipement). */
        function updateUI() {
            document.getElementById('hpValue').innerText = Math.max(0, state.hp);
            document.getElementById('goldValue').innerText = state.gold;
            
            const atk = state.equipment.rightHand?.value || 0;
            const def = (state.equipment.leftHand?.value || 0) + (state.equipment.armor?.value || 0);
            
            document.getElementById('header-stat-atk').innerText = atk;
            document.getElementById('header-stat-def').innerText = def;
            document.getElementById('fatigueProgress').style.width = state.fatigue + "%";
            document.getElementById('fatigueText').innerText = `Fatigue ${state.fatigue}%`;

            ['rightHand', 'leftHand', 'armor'].forEach(slot => {
                const item = state.equipment[slot];
                document.getElementById('name-' + slot).innerText = item ? item.name : 'Vide';
                document.getElementById('icon-' + slot).innerText = item ? item.icon : (slot==='armor'?'üëï':slot==='leftHand'?'üõ°Ô∏è':'‚öîÔ∏è');
                document.getElementById('stat-' + slot).innerText = item ? (slot==='rightHand'?'ATK +':'DEF +') + item.value : '';
                document.getElementById('ui-slot-' + slot).classList.toggle('active', !!item);
            });

            if (healthChart) {
                // Mettre √† jour le graphique de sant√©
                healthChart.data.datasets[0].data = [state.hp, 100 - state.hp];
                healthChart.update();
            }
        }

        /** * Rend le contenu d'une nouvelle √©tape de l'histoire et met √† jour les actions.
         * @param {string} stepId - L'ID de l'√©tape de l'histoire.
         */
        function renderStep(stepId) {
            const step = storyData[stepId];
            if (!step) return;
            
            // Si on change d'√©tape, on sauve avant de potentiellement appliquer des effets
            saveGame(); 

            state.currentStep = stepId;
            if (step.onEnter) step.onEnter();

            document.getElementById('currentLocationTitle').innerText = step.title;
            document.getElementById('storyLog').innerHTML = `
                <div class="fade-in bg-stone-900/50 p-6 rounded-xl border border-stone-800">
                    <p class="story-text text-stone-300 text-sm italic">${step.text}</p>
                </div>`;

            const panel = document.getElementById('actionPanel');
            panel.innerHTML = '';
            step.actions.forEach(act => {
                const canAfford = !act.cost || state.gold >= act.cost;
                const btn = document.createElement('button');
                btn.className = `action-btn p-4 rounded-xl flex justify-between items-center text-[9px] font-bold uppercase tracking-widest ${!canAfford ? 'disabled' : ''}`;
                btn.innerHTML = `<span>${act.icon} ${act.label} ${act.cost ? `(${act.cost}g)` : ''}</span> <span>‚Üí</span>`;
                btn.onclick = () => {
                    if (act.cost) state.gold -= act.cost;
                    if (act.fatigue) state.fatigue = Math.min(100, state.fatigue + act.fatigue);
                    renderStep(act.next);
                };
                panel.appendChild(btn);
            });
            updateUI();
        }

        /** Met √† jour la liste des objets dans l'onglet Inventaire. */
        function updateInventoryUI() {
            const list = document.getElementById('inventoryList');
            list.innerHTML = state.inventory.map(item => {
                // V√©rifie si l'objet est actuellement √©quip√©
                const isEq = Object.values(state.equipment).some(e => e?.id === item.id);
                const limit = STOCK_LIMITS[item.id];
                const atMax = limit && item.count >= limit;

                // G√©n√©ration des caract√©ristiques affich√©es
                let statsHtml = '';
                if (item.value) statsHtml = `<span class="text-blue-400"> +${item.value} ${item.type==='weapon'?'ATK':'DEF'}</span>`;
                if (item.heal) statsHtml = `<span class="text-red-400"> +${item.heal} PV</span>`;
                if (item.restoreFatigue) statsHtml = `<span class="text-purple-400"> √ânergie MAX</span>`;
                if (!statsHtml && item.type === 'consumable') statsHtml = `<span class="text-stone-400"> Consommable</span>`;


                return `
                    <div onclick="useItem('${item.id}')" class="item-card p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:border-stone-700 ${isEq ? 'border-blue-500 bg-blue-900/10' : ''} ${atMax ? 'at-max' : ''}">
                        <span class="text-2xl">${item.icon}</span>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h3 class="text-[10px] font-bold uppercase text-stone-100">
                                    ${item.name} ${statsHtml}
                                </h3>
                                <span class="text-[9px] font-bold ${atMax ? 'text-red-500' : 'text-stone-500'}">
                                    ${limit ? `${item.count}` : ''}
                                    ${limit ? `<span class="text-[7px]"> / ${limit}</span>` : ''}
                                </span>
                            </div>
                            <p class="text-[8px] text-stone-500 italic mt-1">${item.desc}</p>
                        </div>
                        ${isEq ? '<span class="text-[8px] bg-blue-500 text-white px-2 py-0.5 rounded font-bold uppercase">√âquip√©</span>' : ''}
                    </div>`;
            }).join('');
        }

        /** * Affiche une notification temporaire en haut de l'onglet Histoire.
         * @param {string} msg - Le message √† afficher.
         * @param {boolean} error - Indique si c'est un message d'erreur.
         */
        function showNotification(msg, error = false) {
            const area = document.getElementById('itemNotificationArea');
            const el = document.createElement('div');
            el.className = `fade-in p-2 px-3 rounded text-[9px] font-bold uppercase tracking-widest border-l-2 ${error ? 'bg-red-900/20 text-red-400 border-red-500' : 'bg-blue-900/20 text-blue-300 border-blue-500'}`;
            el.innerText = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        /** * Change l'onglet actif.
         * @param {string} id - L'ID de l'onglet √† activer ('story', 'inventory', etc.).
         */
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.replace('text-blue-500', 'text-stone-600'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('nav-' + id).classList.replace('text-stone-600', 'text-blue-500');
            if(id === 'inventory') updateInventoryUI();
            if(id === 'journal') {
                document.getElementById('journalList').innerHTML = state.notes.map(n => `<div class="p-3 bg-stone-900 border border-stone-800 rounded text-[10px] italic text-stone-500">${n}</div>`).join('');
            }
            if(id === 'settings') updateSaveUI();
        }

        /** Sauvegarde l'√©tat actuel du jeu dans localStorage. */
        function saveGame() {
            localStorage.setItem('ls_save', JSON.stringify(state));
        }

        /** Met √† jour l'interface utilisateur de l'onglet Sauvegarde. */
        function updateSaveUI() {
            const list = document.getElementById('saveList');
            const hasSave = localStorage.getItem('ls_save');
            list.innerHTML = hasSave ? `
                <div class="p-4 bg-stone-900 rounded-lg flex justify-between items-center border border-stone-800">
                    <span class="text-[10px] font-bold uppercase">Sauvegarde Automatique</span>
                    <button onclick="loadGame()" class="text-blue-400 text-[10px] font-bold uppercase">Charger</button>
                </div>` : '<p class="text-[10px] text-stone-600 text-center">Aucune sauvegarde trouv√©e</p>';
        }

        /** Charge l'√©tat du jeu depuis localStorage. */
        function loadGame() {
            const saved = localStorage.getItem('ls_save');
            if(saved) {
                state = JSON.parse(saved);
                renderStep(state.currentStep);
                switchTab('story');
            }
        }
        
        // --- Custom Modal Implementation (Replaces confirm()) ---
        let currentConfirmAction = null;

        /** * Affiche la modale de confirmation.
         * @param {string} message - Message √† afficher.
         * @param {Function} confirmAction - Fonction √† ex√©cuter si l'utilisateur confirme.
         */
        function showConfirmationModal(message, confirmAction) {
            document.getElementById('modalMessage').innerText = message;
            currentConfirmAction = confirmAction;
            document.getElementById('customModal').classList.remove('hidden');
        }

        /**
         * G√®re la fermeture de la modale.
         * @param {boolean} confirmed - Vrai si l'action a √©t√© confirm√©e.
         */
        function closeModal(confirmed) {
            document.getElementById('customModal').classList.add('hidden');
            if (confirmed && currentConfirmAction) {
                currentConfirmAction();
            }
            currentConfirmAction = null;
        }

        /** G√®re le clic sur le bouton Confirmer de la modale. */
        function modalConfirmHandler() {
            closeModal(true);
        }
        // --- Fin Custom Modal ---

        /** Utilise la modale custom pour demander la confirmation de l'effacement. */
        function confirmReset() {
            showConfirmationModal("√ätes-vous s√ªr de vouloir effacer toute votre progression ? Cette action est irr√©versible.", () => {
                localStorage.removeItem('ls_save');
                // Recharger la page apr√®s effacement
                location.reload(); 
            });
        }
        
        // Initialisation √† l'ouverture de la fen√™tre
        window.onload = () => {
            // Initialisation du graphique de sant√©
            const ctx = document.getElementById('healthMiniChart').getContext('2d');
            healthChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { datasets: [{ data: [100, 0], backgroundColor: ['#991b1b', '#1c1917'], borderWidth: 0 }] }, 
                options: { cutout: '85%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } 
            });
            
            // Tentative de chargement de la sauvegarde
            const saved = localStorage.getItem('ls_save');
            if(saved) state = JSON.parse(saved);
            
            // D√©marrage du jeu
            renderStep(state.currentStep);
            updateUI(); // S'assurer que les stats sont affich√©es
        };
    </script>
</body>
</html>


